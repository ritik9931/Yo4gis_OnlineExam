@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    var username = Session["username"] as string;
    var studentId = Session["studentId"] as string;
}

<style>
    .page-header {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        padding: 18px 24px;
        border-radius: 12px;
        color: #ffffff;
        margin-bottom: 20px;
    }

        .page-header h5 {
            color: #ffffff;
            font-weight: 600;
        }

        .page-header .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }

            .page-header .breadcrumb a {
                color: #cfe3ff;
            }

        .page-header .breadcrumb-item.active,
        .page-header .breadcrumb-item {
            color: #ffffff;
        }

    /* =========================================
    CARD ENHANCEMENT
    ========================================= */

    .card {
        border-radius: 16px;
        border: none;
        background: #ffffff;
        transition: all 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Card title */
        .card h4 {
            font-weight: 600;
            color: #1e3c72;
        }

    /* =========================================
    FORM CONTROLS
    ========================================= */

    .form-label {
        color: #333;
        margin-bottom: 6px;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid #dcdcdc;
        transition: all 0.25s ease;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.25);
        }

    /* =========================================
    UPLOAD BUTTON
    ========================================= */

    #uploadBtn {
        background: linear-gradient(90deg, #2196f3, #1e88e5);
        border: none;
        padding: 10px 22px;
        font-weight: 600;
        border-radius: 10px;
        letter-spacing: 0.4px;
        transition: all 0.3s ease;
    }

        #uploadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.45);
        }

    /* =========================================
    DATATABLE STYLING
    ========================================= */

    .table {
        border-radius: 12px;
        overflow: hidden;
    }

        .table thead th {
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            color: #0d47a1;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 13px;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa;
    }

    .table-bordered > :not(caption) > * {
        border-color: #e0e0e0;
    }

    /* Hover row effect */
    .table tbody tr:hover {
        background-color: #e3f2fd;
        transition: background 0.2s ease;
    }

    /* =========================================
    DATATABLE CONTROLS (SEARCH, PAGINATION)
    ========================================= */

    .dataTables_filter input {
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 6px 10px;
    }

    .dataTables_paginate .paginate_button {
        border-radius: 6px !important;
        padding: 6px 12px !important;
        margin: 0 2px;
    }

        .dataTables_paginate .paginate_button.current {
            background: linear-gradient(90deg, #2196f3, #1e88e5) !important;
            color: #ffffff !important;
            border: none !important;
        }

        .dataTables_paginate .paginate_button:hover {
            background: #e3f2fd !important;
        }

    .main-content {
        padding: 0 !important;
    }

        /* Remove Bootstrap row gutters */
        .main-content .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Remove column padding */
        .main-content .col-md-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Make card full-width & flush */
        .main-content .card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

            /* Optional: keep inner padding clean */
            .main-content .card.p-4 {
                padding: 20px !important; /* inner spacing only */
            }
</style>
<style>
    .stat-card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

        .stat-card h3 {
            font-weight: 700;
        }
</style>






<div class="page-header" style="border-radius: 0px;">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">Dashboard</h5>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Admin</a></li>
            <li class="breadcrumb-item">Dashboard</li>
        </ul>
    </div>
</div>

<div class="main-content">

    <!-- 🔹 BANNERS ROW -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <h6>Total Assigned Exams</h6>
                    <h3 id="totalAssignedExam">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <h6>Total Completed Exams</h6>
                    <h3 id="totalCompletedExams">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body">
                    <h6>Remaining Exams</h6>
                    <h3 id="totalRemainExams">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white">
                <div class="card-body">
                    <h6>Pass Percentage</h6>
                    <h3 id="passRate">0%</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 🔹 CHARTS ROW -->
    <div class="row g-3">
        <div class="col-md-6 col-lg-3">
            <div class="card p-3">
                <h6 class="mb-3">Students by Subject</h6>
                <canvas id="chartStudentsBySubject"></canvas>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card p-3">
                <h6 class="mb-3">Exams per Month</h6>
                <canvas id="chartExamsPerMonth"></canvas>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card p-3">
                <h6 class="mb-3">Pass vs Fail</h6>
                <canvas id="chartPassFail"></canvas>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="card p-3">
                <h6 class="mb-3">Subject Wise Questions</h6>
                <canvas id="chartTopSubjects"></canvas>
            </div>
        </div>
    </div>

</div>


<script>
    var username = '@username';
    var studentId = '@studentId';
    if (username) {
        sessionStorage.setItem("username", username);
        console.log(username);
    }
    if (studentId) {
        sessionStorage.setItem("studentId", studentId);
        console.log(studentId);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
    $(document).ready(function () {

        GetStudentDashboardData(studentId);
        // Example banner values (replace with AJAX later)


        // Chart 1: Students by Subject
        new Chart(document.getElementById("chartStudentsBySubject"), {
            type: "bar",
            data: {
                labels: ["Math", "Science", "English", "History"],
                datasets: [{
                    label: "Students",
                    data: [30, 40, 25, 25]
                }]
            }
        });

        // Chart 2: Exams per Month
        new Chart(document.getElementById("chartExamsPerMonth"), {
            type: "line",
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May"],
                datasets: [{
                    label: "Exams",
                    data: [5, 8, 6, 10, 6]
                }]
            }
        });

        // Chart 3: Pass vs Fail
        //new Chart(document.getElementById("chartPassFail"), {
        //    type: "doughnut",
        //    data: {
        //        labels: ["Pass", "Fail"],
        //        datasets: [{
        //            data: [78, 22]
        //        }]
        //    }
        //});

        // Chart 4: Top Subjects


    });

    function GetStudentDashboardData(studentId) {
        $.ajax({
            url: "@Url.Action("GetStudentDashboardData", "Home")?studentid=" + studentId,
            crossDomain: true,
            success: function (data) {

                $("#totalCompletedExams").text(data.data.cntCompletedExam);
                $("#totalAssignedExam").text(data.data.cntAssignedExam);
                $("#totalRemainExams").text(data.data.cntRemainingExam);
                var percentage = data.data.passPercentage.toLocaleString() + "%"
                $("#passRate").text(percentage);

                //var resultData = _.map(data.data.passFailCount[0], function (innerArray) {
                //    var obj = {};
                //    _.each(innerArray, function (item) {
                //        obj[item.Key] = item.Value;
                //    });
                //    return obj;
                //});
                //console.log(resultData);

                var values= [_.findWhere(data.data.passFailCount[0], { Key: 'pass_count' }).Value, _.findWhere(data.data.passFailCount[0], { Key: 'fail_count' }).Value];
        var labels = ['Pass Count','Fail Count']

                new Chart(document.getElementById("chartPassFail"), {
                    type: "pie",
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            datalabels: {
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                formatter: function (value, context) {
                                    return value; // show count
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });


               

                //studentTable.clear().rows.add(resultData).draw();
            }
        });
    }
</script>
