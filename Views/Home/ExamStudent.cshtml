
@{
    ViewBag.Title = "ExamStudent";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style>
    .page-header {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        padding: 18px 24px;
        border-radius: 12px;
        color: #ffffff;
        margin-bottom: 20px;
    }

        .page-header h5 {
            color: #ffffff;
            font-weight: 600;
        }

        .page-header .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }

            .page-header .breadcrumb a {
                color: #cfe3ff;
            }

        .page-header .breadcrumb-item.active,
        .page-header .breadcrumb-item {
            color: #ffffff;
        }

    /* =========================================
    CARD ENHANCEMENT
    ========================================= */

    .card {
        border-radius: 16px;
        border: none;
        background: #ffffff;
        transition: all 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Card title */
        .card h4 {
            font-weight: 600;
            color: #1e3c72;
        }

    /* =========================================
    FORM CONTROLS
    ========================================= */

    .form-label {
        color: #333;
        margin-bottom: 6px;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid #dcdcdc;
        transition: all 0.25s ease;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.25);
        }

    /* =========================================
    UPLOAD BUTTON
    ========================================= */

    #uploadBtn {
        background: linear-gradient(90deg, #2196f3, #1e88e5);
        border: none;
        padding: 10px 22px;
        font-weight: 600;
        border-radius: 10px;
        letter-spacing: 0.4px;
        transition: all 0.3s ease;
    }

        #uploadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.45);
        }

    /* =========================================
    DATATABLE STYLING
    ========================================= */

    .table {
        border-radius: 12px;
        overflow: hidden;
    }

        .table thead th {
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            color: #0d47a1;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 13px;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa;
    }

    .table-bordered > :not(caption) > * {
        border-color: #e0e0e0;
    }

    /* Hover row effect */
    .table tbody tr:hover {
        background-color: #e3f2fd;
        transition: background 0.2s ease;
    }

    /* =========================================
    DATATABLE CONTROLS (SEARCH, PAGINATION)
    ========================================= */

    .dataTables_filter input {
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 6px 10px;
    }

    .dataTables_paginate .paginate_button {
        border-radius: 6px !important;
        padding: 6px 12px !important;
        margin: 0 2px;
    }

        .dataTables_paginate .paginate_button.current {
            background: linear-gradient(90deg, #2196f3, #1e88e5) !important;
            color: #ffffff !important;
            border: none !important;
        }

        .dataTables_paginate .paginate_button:hover {
            background: #e3f2fd !important;
        }

    .main-content {
        padding: 0 !important;
    }

        /* Remove Bootstrap row gutters */
        .main-content .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Remove column padding */
        .main-content .col-md-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Make card full-width & flush */
        .main-content .card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

            /* Optional: keep inner padding clean */
            .main-content .card.p-4 {
                padding: 20px !important; /* inner spacing only */
            }
</style>


<div class="page-header" style="border-radius: 0px;">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">Analytics</h5>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Admin</a></li>
            <li class="breadcrumb-item">Exam Student</li>
        </ul>
    </div>
</div>

<div class="main-content">
    <div class="row">
        <div class="col-md-12">
            <div class="card p-4">
                <h4>Exam Student Assign</h4>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label>Select Exam</label>
                        <select id="ddlExam" class="form-control">
                            <option value="">Select Exam</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label>Select Batch</label>
                        <select id="ddlBatch" class="form-control">
                            <option value="ALL">All Batch</option>
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <button id="btnSubmit" class="btn btn-primary w-100">Assign</button>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">Student Exam Map List</h5>
                <div class="table-responsive">
                    <table id="tblExistingExamStudent" class="ritik table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Exam Name</th>
                                <th>Status</th>
                                <th>No Of Attempt</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <h5 class="mb-3">Student List</h5>
                <div class="table-responsive">
                    <table id="tblQuestions" class="ritik table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Mobile Number</th>
                                <th>
                                    <input type="checkbox" id="selectAll" />
                                </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var studentTable = null;
    var studentExamTable = null;
    $(document).ready(function () {
        GetAllExamAndSubject();

        $('#btnSubmit').on('click', function () {

            let examName = $("#ddlExam option:selected").text();
            let exam_id = $("#ddlExam option:selected").val();
            var selectedIds = [];
            var studentExam = [];



            studentTable.$('.row-check:checked').each(function () {
                var obj = {};
                obj.exam_id = exam_id;
                obj.student_id = $(this).val();
                studentExam.push(obj);
                selectedIds.push($(this).val());
            });

            if (studentExam.length != 0) {

                $.ajax({
                    url: "@Url.Action("SaveExamStudent", "Home")",   // Controller action
                    type: 'POST',
                    data: JSON.stringify(studentExam),
                    contentType: 'application/json; charset=utf-8',
                    success: function (res) {
                        if (res.success) {
                            toastr.success(res.message, "Success");
                            GetStudentByBatch('0');
                        } else {
                            toastr.error(res.message, "Error");
                        }
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Error while sending data to server.");
                    }
                });
            }
            else {
                toastr.error("No Student Selected", "Success");
            }
            //alert("Selected Count: " + selectedIds.length + "\nIDs: " + selectedIds.join(', '));
            //let examName = $('#txtExamName').val();
            //let examSubject = $('#ddlSubject').val();
            //var dataObj = { "sub_name": from, "sub_code": to };
            //saveSubject(dataObj);
            //alert('From: ' + from + '\nTo: ' + to);
        });

        $('#ddlBatch').on('change', function () {
            let selectedValue = $(this).val();
            let selectedText = $("#ddlSubject option:selected").text();
            GetStudentByBatch(selectedValue);
            console.log("Selected Value:", selectedValue);
            console.log("Selected Text:", selectedText);
        });


                studentTable=$('#tblQuestions').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    lengthChange: true,
                    columns: [
                        { data: "id" },
                        { data: "name" },
                        { data: "mobile_number" },
                       {
                            data: "id",
                            render: function (data, type, row) {
                                return `<input type="checkbox" class="row-check" value="${data}">`;
                            },
                            orderable: false
                        }
                    ]
                });

        studentExamTable = $('#tblExistingExamStudent').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            lengthChange: true,
            columns: [
                { data: "id" },
                { data: "name" },
                { data: "exam_title" },
                { data: "status" },
                { data: "attempt_no" },
                {
                    data: null,
                    title: "Action",
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
            <div style="display:flex; gap:6px; justify-content:center;">
                 <button class="btn btn-sm btn-danger btn-delete" data-exam-id="${row.exam_id}" data-student-id="${row.student_id}">
                     Delete
                 </button>
            </div>
        `;
                    }
                }
            ]
        });




        $('#selectAll').on('change', function () {
            $('.row-check').prop('checked', this.checked);
        });

        loadExistingDate();
        GetStudentByBatch('0');
     });


    function loadExistingDate() {
        $.ajax({
            url: "@Url.Action("GetExamAndStudentList", "Home")",
            crossDomain: true,
            success: function (data) {
                console.log(data);
                var resultData = _.map(data.data, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });
                studentExamTable.clear().rows.add(resultData).draw();

            }
            });
    }


    function loadExams(subjects) {
        var resultData = _.map(subjects, function (innerArray) {
            var obj = {};
            _.each(innerArray, function (item) {
                obj[item.Key] = item.Value;
            });
            return obj;
        });

        let ddl = $('#ddlExam');
        ddl.empty();
        ddl.append(`<option value="ALL">Select Exam</option>`);
        $.each(resultData, function (i, item) {
            ddl.append(`<option value="${item.exam_id}">${item.exam_title}</option>`);
        });

        ddl.val("ALL"); // Set default
    }

    function loadBatch(subjects) {
        var resultData = _.map(subjects, function (innerArray) {
            var obj = {};
            _.each(innerArray, function (item) {
                obj[item.Key] = item.Value;
            });
            return obj;
        });

        let ddl = $('#ddlBatch');
        ddl.empty();
        ddl.append(`<option value="0">All Batch</option>`);
        $.each(resultData, function (i, item) {
            ddl.append(`<option value="${item.id}">${item.batch_name}</option>`);
        });

        ddl.val("0"); // Set default
    }


    function GetQuestionsBySubject(subject) {
        $.ajax({
            url: "@Url.Action("GetQuestionsBySubject", "Home")?subject=" + subject,
            crossDomain: true,
            success: function (data) {
            console.log(data);

            }
            });
            }

            function GetAllExamAndSubject() {
            $.ajax({
            url: "@Url.Action("GetAllExamAndSubjectAndBatch", "Home")",
            crossDomain: true,
            success: function (data) {
            console.log(data);
            loadExams(data.data.examData);
            loadBatch(data.data.batchData);
            }
            });
            }

            function GetStudentByBatch(batchid) {
            $.ajax({
            url: "@Url.Action("GetStudentByBatch", "Home")?batchid=" + batchid,
            crossDomain: true,
            success: function (data) {
                console.log(data);
                var resultData = _.map(data.data, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });

                studentTable.clear().rows.add(resultData).draw();

            }
            });
    }

    //deleteExam

  $('#tblExistingExamStudent').on('click', '.btn-delete', function () {
    var examId = $(this).data('exam-id');
    var studentId = $(this).data('student-id');

    Swal.fire({
        title: 'Are you sure?',
        text: 'This will delete ALL attempts of this student for this exam.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#d33'
    }).then((result) => {

        console.log(result); 

        if (result.value === true) {

            $.ajax({
                url: "@Url.Action("DeleteExamStudent", "Home")",
                type: "POST",
                data: {
                    examId: examId,
                    studentId: studentId
                },
                success: function (res) {
                    if (res.success) {
                        Swal.fire('Deleted!', 'All attempts have been deleted.', 'success');
                        loadExistingDate();
                    } else {
                        Swal.fire('Error!', res.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error!', 'Server error occurred.', 'error');
                }
            });

        }
    });
});



</script>

