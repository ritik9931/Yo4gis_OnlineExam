
@{
    ViewBag.Title = "Exams";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.7/underscore-min.js" integrity="sha512-dvWGkLATSdw5qWb2qozZBRKJ80Omy2YN/aF3wTUVC5+D1eqbA+TjWpPpoj8vorK5xGLMa2ZqIeWCpDZP/+pQGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
    .page-header {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        padding: 18px 24px;
        border-radius: 12px;
        color: #ffffff;
        margin-bottom: 20px;
    }

        .page-header h5 {
            color: #ffffff;
            font-weight: 600;
        }

        .page-header .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }

            .page-header .breadcrumb a {
                color: #cfe3ff;
            }

        .page-header .breadcrumb-item.active,
        .page-header .breadcrumb-item {
            color: #ffffff;
        }

    /* =========================================
    CARD ENHANCEMENT
    ========================================= */

    .card {
        border-radius: 16px;
        border: none;
        background: #ffffff;
        transition: all 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Card title */
        .card h4 {
            font-weight: 600;
            color: #1e3c72;
        }

    /* =========================================
    FORM CONTROLS
    ========================================= */

    .form-label {
        color: #333;
        margin-bottom: 6px;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid #dcdcdc;
        transition: all 0.25s ease;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.25);
        }

    /* =========================================
    UPLOAD BUTTON
    ========================================= */

    #uploadBtn {
        background: linear-gradient(90deg, #2196f3, #1e88e5);
        border: none;
        padding: 10px 22px;
        font-weight: 600;
        border-radius: 10px;
        letter-spacing: 0.4px;
        transition: all 0.3s ease;
    }

        #uploadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.45);
        }

    /* =========================================
    DATATABLE STYLING
    ========================================= */

    .table {
        border-radius: 12px;
        overflow: hidden;
    }

        .table thead th {
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            color: #0d47a1;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 13px;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa;
    }

    .table-bordered > :not(caption) > * {
        border-color: #e0e0e0;
    }

    /* Hover row effect */
    .table tbody tr:hover {
        background-color: #e3f2fd;
        transition: background 0.2s ease;
    }

    /* =========================================
    DATATABLE CONTROLS (SEARCH, PAGINATION)
    ========================================= */

    .dataTables_filter input {
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 6px 10px;
    }

    .dataTables_paginate .paginate_button {
        border-radius: 6px !important;
        padding: 6px 12px !important;
        margin: 0 2px;
    }

        .dataTables_paginate .paginate_button.current {
            background: linear-gradient(90deg, #2196f3, #1e88e5) !important;
            color: #ffffff !important;
            border: none !important;
        }

        .dataTables_paginate .paginate_button:hover {
            background: #e3f2fd !important;
        }

    .main-content {
        padding: 0 !important;
    }

        /* Remove Bootstrap row gutters */
        .main-content .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Remove column padding */
        .main-content .col-md-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Make card full-width & flush */
        .main-content .card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

            /* Optional: keep inner padding clean */
            .main-content .card.p-4 {
                padding: 20px !important; /* inner spacing only */
            }
</style>





<div class="page-header">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">Analytics</h5>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Admin</a></li>
            <li class="breadcrumb-item">Exams</li>
        </ul>
    </div>
</div>

<div class="main-content">
    <div class="row">
        <div class="col-md-12">
            <div class="card p-4">
                <h4>Exam Master</h4>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label>Exam Name</label>
                        <input type="text" id="txtExamName" class="form-control" placeholder="Enter keyword">
                    </div>

                    <div class="col-md-4">
                        <label>Select Subject</label>
                        <select id="ddlSubject" class="form-control">
                            <option value="ALL">Select All</option>
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <button id="btnSubmit" class="btn btn-primary w-100">Submit</button>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">Exam Details</h5>
                <div class="table-responsive">
                    <table id="tblQuestions" class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Exam Name</th>
                                <th>Subject Name</th>
                                <th>Number Of Questions</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <hr>
                <h5 class="mb-3">Questions Bank</h5>
                <div class="table-responsive">
                    <table id="tblQuestions1" class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Question</th>
                                <th>Option A</th>
                                <th>Option B</th>
                                <th>Option C</th>
                                <th>Option D</th>
                                <th>Correct Option</th>
                                <th>Subject</th>
                                <th>Hardness</th>
                                @*<th>
                                    <input type="checkbox" id="selectAll" />
                                </th>*@
                                <th>Select</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<script>
    var examTable = null;
    var questionTable = null;
     $(document).ready(function () {
         GetAllExamAndSubject();
        $('#btnSubmit').on('click', function () {
            let examName = $('#txtExamName').val();
            let examSubject = $('#ddlSubject').val();
            //var dataObj = { "sub_name": from, "sub_code": to };
            if (examName.trim() === "") {
                toastr.error("All Fields need to fill", "Success");
            }
            else {
                saveExamAndQuestions(examName, examSubject);
            }
            //alert('From: ' + from + '\nTo: ' + to);
        });

         $('#ddlSubject').on('change', function () {
             let selectedValue = $(this).val();
             let selectedText = $("#ddlSubject option:selected").text();
             GetQuestionsBySubject(selectedText);
             console.log("Selected Value:", selectedValue);
             console.log("Selected Text:", selectedText);
         });

         examTable = $('#tblQuestions').DataTable({
             paging: true,
             searching: true,
             ordering: true,
             lengthChange: true,
             columns: [
                 { data: "exam_id" },
                 { data: "exam_title" },
                 { data: "subject_title" },
                 { data: "number_questions" },
                 {
                     data: null,
                     title: "Action",
                     orderable: false,
                     searchable: false,
                     render: function (data, type, row) {
                         return `
            <div style="display:flex; gap:6px; justify-content:center;">
                <button class="btn btn-sm btn-primary btn-edit" data-id="${row.subject_id}">
                    Edit
                </button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${row.subject_id}">
                    Delete
                </button>
            </div>
        `;
                     }
                 }
             ]
         });

         questionTable = $('#tblQuestions1').DataTable({
             paging: true,
             searching: true,
             ordering: true,
             lengthChange: true,
             columns: [
                 { data: "id" },
                 { data: "question_text" },
                 { data: "option_a" },
                 { data: "option_b" },
                 { data: "option_c" },
                 { data: "option_d" },
                 { data: "correct_option" },
                 { data: "sub_name" },
                 { data: "difficulty" },
                 {
                     data: "id",
                     render: function (data, type, row) {
                         return `<input type="checkbox" class="row-check" value="${data}">`;
                     },
                     orderable: false
                 },
                 {
                     data: null,
                     title: "Action",
                     orderable: false,
                     searchable: false,
                     render: function (data, type, row) {
                         return `
            <div style="display:flex; gap:6px; justify-content:center;">
                <button class="btn btn-sm btn-primary btn-edit" data-id="${row.subject_id}">
                    Edit
                </button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${row.subject_id}">
                    Delete
                </button>
            </div>
        `;
                     }
                 }
             ]
         });


     });

    function saveExamAndQuestions(examName, examSubject) {
        var objArray = [];
        $('.row-check:checked').each(function () {
            var obj = {};
            obj.exam_name = examName;
            obj.subject_id = examSubject;
            obj.question_id = $(this).val();
            //alert($(this).val());
            objArray.push(obj);
            //selectedIds.push($(this).val());
        });

        if (objArray.length != 0) {

            $.ajax({
                url: "@Url.Action("saveExamAndQuestions", "Home")",   // Controller action
                type: 'POST',
                data: JSON.stringify(objArray),
                contentType: 'application/json; charset=utf-8',
                success: function (res) {
                    if (res.success) {
                        toastr.success(res.message, "Success");

                    } else {
                        toastr.error(res.message, "Success");
                    }
                },
                error: function (err) {
                    console.error(err);
                    alert("Error while sending data to server.");
                }
            });
        }
        else {
            toastr.error("No Question Selected", "Success");
        }



    }

    function loadSubjects(subjects) {
        var resultData = _.map(subjects, function (innerArray) {
            var obj = {};
            _.each(innerArray, function (item) {
                obj[item.Key] = item.Value;
            });
            return obj;
        });

        let ddl = $('#ddlSubject');
        ddl.empty();
        ddl.append(`<option value="ALL">Select All</option>`);
        $.each(resultData, function (i, item) {
            ddl.append(`<option value="${item.subject_id}">${item.subject_title}</option>`);
        });

        ddl.val("ALL"); // Set default
    }

    function GetQuestionsBySubject(subject) {
        $.ajax({
            url: "@Url.Action("GetQuestionsBySubject", "Home")?subject=" + subject,
            crossDomain: true,
            success: function (data) {
                console.log(data);
                var resultData = _.map(data.data, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });



                questionTable.clear().rows.add(resultData).draw();
            }
        });
    }

    function GetAllExamAndSubject() {
        $.ajax({
            url: "@Url.Action("GetAllExamAndSubjectAndBatch", "Home")",
            crossDomain: true,
            success: function (data) {
                console.log(data);
                loadSubjects(data.data.subjectData);
                var resultData = _.map(data.data.examData, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });
                examTable.clear().rows.add(resultData).draw();

            }
        });
    }
</script>

