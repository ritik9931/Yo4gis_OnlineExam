
@{
    ViewBag.Title = "Exam";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>

    /* Sticky Timer */
    .timer-box {
        position: fixed;
        top: 75px;
        right: 15px;
        background: #212529;
        color: #fff;
        padding: 10px 16px;
        border-radius: 30px;
        font-size: 15px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }


    /* Quiz Container */
    .quiz-container {
        max-width: 900px;
        margin: auto;
    }

    /* Question Card */
    .question-card {
        background: #ffffff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        border-left: 5px solid #0d6efd;
    }

        .question-card h5 {
            font-weight: 600;
            margin-bottom: 15px;
        }

    /* Options */
    .option-item {
        display: block;
        background: #f8f9fa;
        border: 2px solid transparent;
        border-radius: 6px;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }

        .option-item:hover {
            background: #e7f1ff;
            border-color: #0d6efd;
        }

        .option-item input[type="radio"] {
            margin-right: 10px;
        }

        .option-item.selected {
            background: #e7f1ff;
            border-color: #0d6efd;
            font-weight: 600;
        }

    /* Submit Button */
    .submit-btn {
        background: linear-gradient(45deg, #0d6efd, #6610f2);
        color: white;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 30px;
        border: none;
        transition: 0.3s;
    }

        .submit-btn:hover {
            background: linear-gradient(45deg, #6610f2, #0d6efd);
            transform: translateY(-1px);
        }

    .page-header {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        padding: 18px 24px;
        border-radius: 12px;
        color: #ffffff;
        margin-bottom: 20px;
    }

        .page-header h5 {
            color: #ffffff;
            font-weight: 600;
        }

        .page-header .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }

            .page-header .breadcrumb a {
                color: #cfe3ff;
            }

        .page-header .breadcrumb-item.active,
        .page-header .breadcrumb-item {
            color: #ffffff;
        }

    /* =========================================
    CARD ENHANCEMENT
    ========================================= */

    .card {
        border-radius: 16px;
        border: none;
        background: #ffffff;
        transition: all 0.3s ease;
    }

        .card:hover {
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Card title */
        .card h4 {
            font-weight: 600;
            color: #1e3c72;
        }

    /* =========================================
    FORM CONTROLS
    ========================================= */

    .form-label {
        color: #333;
        margin-bottom: 6px;
    }

    .form-control,
    .form-select {
        border-radius: 10px;
        padding: 10px 14px;
        border: 1px solid #dcdcdc;
        transition: all 0.25s ease;
    }

        .form-control:focus,
        .form-select:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.25);
        }

    /* =========================================
    DATATABLE STYLING
    ========================================= */

    .table {
        border-radius: 12px;
        overflow: hidden;
    }

        .table thead th {
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            color: #0d47a1;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 13px;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #fafafa;
    }

    .table-bordered > :not(caption) > * {
        border-color: #e0e0e0;
    }

    /* Hover row effect */
    .table tbody tr:hover {
        background-color: #e3f2fd;
        transition: background 0.2s ease;
    }

    /* =========================================
    DATATABLE CONTROLS (SEARCH, PAGINATION)
    ========================================= */

    .dataTables_filter input {
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 6px 10px;
    }

    .dataTables_paginate .paginate_button {
        border-radius: 6px !important;
        padding: 6px 12px !important;
        margin: 0 2px;
    }

        .dataTables_paginate .paginate_button.current {
            background: linear-gradient(90deg, #2196f3, #1e88e5) !important;
            color: #ffffff !important;
            border: none !important;
        }

        .dataTables_paginate .paginate_button:hover {
            background: #e3f2fd !important;
        }

    .main-content {
        padding: 0 !important;
    }

        /* Remove Bootstrap row gutters */
        .main-content .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Remove column padding */
        .main-content .col-md-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Make card full-width & flush */
        .main-content .card {
            margin: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

            /* Optional: keep inner padding clean */
            .main-content .card.p-4 {
                padding: 20px !important; /* inner spacing only */
            }
</style>

<div class="page-header">
    <div class="page-header-left d-flex align-items-center">
        <div class="page-header-title">
            <h5 class="m-b-10">Analytics</h5>
        </div>
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Student</a></li>
            <li class="breadcrumb-item">Exams</li>
        </ul>
    </div>
</div>

<div class="main-content">
    <div class="row">
        <div class="col-md-12">
            <div class="card p-4">
                <h4>Assigned Exam</h4>
                <div class="table-responsive">
                    <table id="tblQuestions" class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Student ID</th>
                                <th>Exam Name</th>
                                <th>Subject Code</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">



        <div class="quiz-container mt-4">
            <form id="quizForm">
                <div id="questionsArea"></div>
                <div class="text-center my-4" style="display:none">
                    <button type="submit" class="submit-btn">Submit Exam</button>
                </div>
            </form>
        </div>

    </div>
</div>
<div id="idTimer" class="timer-box" style="display:none">
    ⏳ Time Left: <span id="timer">30:00</span>
</div>

<script>
    var studentTable = null;
    var exam_id = null;
    var student_id = null;
    $(document).ready(function () {
        GetAllAssignedExam();
        $('#btnSubmit').on('click', function () {
            let from = $('#subName').val();
            let to = $('#subCode').val();
            var dataObj = { "sub_name": from, "sub_code": to };
            saveSubject(dataObj);
            //alert('From: ' + from + '\nTo: ' + to);
        });

        $("#quizForm").on("submit", function (e) {
            //e.preventDefault();

            let answers = [];
           
            $('.question-card').each(function () {
                let questionId = $(this).data('question-id');
                let selected = $(this).find('input[type=radio]:checked').val();

                if (selected) {
                    answers.push({
                        QuestionId: questionId,
                        SelectedOption: selected,
                        ExamId: exam_id,
                        StudentId: student_id
                    });
                }
            });

            //$.ajax({
            //    url: '/Quiz/SubmitAnswers',
            //    type: 'POST',
            //    data: formData,
            //    success: function (res) {
            //        if (res.success) {
            //            alert("Exam submitted!\nScore: " + res.score + " / " + res.total);
            //            location.reload(); // or redirect
            //        }
            //    }
            //});
             $.ajax({
    url: "@Url.Action("SubmitAnswers", "Home")",   // Controller action
    type: 'POST',
                 data: JSON.stringify(answers),
    contentType: 'application/json; charset=utf-8',
    success: function (res) {
        if (res.success) {
            toastr.success(res.message, "Success");

        } else {
            toastr.error(res.message, "Error");
        }
    },
    error: function (err) {
        console.error(err);
        alert("Error while sending data to server.");
    }
});
        });


        studentTable = $('#tblQuestions').DataTable({
            paging: false,
            searching: false,
            ordering: false,
            lengthChange: false,
            columns: [
                { data: "student_id" },
                { data: "exam_title" },
                { data: "subject_title" },

                {
                    data: null,
                    title: "Action",
                    orderable: false,
                    searchable: false,
                    render: function (data, type, row) {
                        return `
            <div style="display:flex; gap:6px; justify-content:center;">
                <button class="btn btn-sm btn-primary btn-edit" data-student-id="${row.student_id}" data-id="${row.exam_id}">
                    Start
                </button>
                <button class="btn btn-sm btn-danger btn-delete" data-id="${row.exam_id}">
                    Mark As Completed
                </button>
            </div>
        `;
                    }
                }
            ]
        });

        $('#tblQuestions').on('click', '.btn-edit', function () {
            var id = $(this).data('id');
            exam_id = $(this).data('id');
            student_id = $(this).data('student-id');
            GetExamQuestionForQuiz(id);
            alert("Edit clicked for ID: " + id);
            // open modal / redirect / load data
        });

    });

    function GetExamQuestionForQuiz(examId) {
        $.ajax({
            url: "@Url.Action("GetExamQuestionForQuiz", "Home")?examID=" + examId + "&student_id=" + student_id,
            crossDomain: true,
            success: function (data) {
                console.log(data);
                var resultData = _.map(data.data, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });
                console.log(resultData);
                $("#quizContainer").show();
                $("#idTimer").show();
                let html = "";

                $.each(resultData, function (i, q) {
                    html += `
                <div class="question-card" data-question-id="${q.id}">
                    <h5>${i + 1}. ${q.question_text}</h5>
                    <input type="hidden" name="answers[${i}].QuestionId" value="${q.id}" />

                    <label class="option-item">
                        <input type="radio" name="answers[${i}].SelectedOption" value="A" />
                        ${q.option_a}
                    </label>
                    <label class="option-item">
                        <input type="radio" name="answers[${i}].SelectedOption" value="B" />
                        ${q.option_b}
                    </label>
                    <label class="option-item">
                        <input type="radio" name="answers[${i}].SelectedOption" value="C" />
                        ${q.option_c}
                    </label>
                    <label class="option-item">
                        <input type="radio" name="answers[${i}].SelectedOption" value="D" />
                        ${q.option_d}
                    </label>
                </div>`;
                });

                $("#questionsArea").html(html);
                startTimer(30 * 60); // 30 minutes

            }
        });
    }

    function startTimer(duration) {
        let timeLeft = duration;
        const timerEl = document.getElementById("timer");

        const interval = setInterval(function () {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerEl.textContent = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

            if (--timeLeft < 0) {
                clearInterval(interval);
                alert("Time is up! Submitting exam...");
                $("#quizForm").submit();
            }
        }, 1000);
    }


    var user = null;
    function GetAllAssignedExam() {
        user = sessionStorage.getItem("username");
        console.log("Logged in user:", user);

        $.ajax({
            url: "@Url.Action("GetStudentAssignedExam", "Home")?studentId="+user,
            crossDomain: true,
            success: function (data) {
                console.log(data);
                var resultData = _.map(data.data, function (innerArray) {
                    var obj = {};
                    _.each(innerArray, function (item) {
                        obj[item.Key] = item.Value;
                    });
                    return obj;
                });
                studentTable.clear().rows.add(resultData).draw();
            }
        });
    }

    function saveSubject(dataToSend) {
        $.ajax({
    url: "@Url.Action("saveSubject", "Home")",   // Controller action
    type: 'POST',
    data: JSON.stringify(dataToSend),
    contentType: 'application/json; charset=utf-8',
    success: function (res) {
        if (res.success) {
            toastr.success("Subject Added successfully!", "Success");
            //alert("Questions saved successfully!");
            GetAllSubject();
        } else {
            toastr.error(res.message, "Success");
        }
    },
    error: function (err) {
        console.error(err);
        alert("Error while sending data to server.");
    }
});
    }

</script>

